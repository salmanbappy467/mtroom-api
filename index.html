<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>REB Automation v8.8 (Vertical Align)</title>
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/3655/3655563.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        bg: '#131314',
                        surface: '#1E1F20',
                        surface2: '#2D2E30',
                        primary: '#8AB4F8',
                        text: '#E3E3E3',
                        textDim: '#9AA0A6',
                        border: '#3C4043'
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #131314; color: #E3E3E3; font-family: 'Segoe UI', sans-serif; }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1E1F20; }
        ::-webkit-scrollbar-thumb { background: #3C4043; border-radius: 3px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .loader {
            border: 2px solid transparent; border-top: 2px solid currentColor; border-radius: 50%;
            width: 14px; height: 14px; animation: spin 0.8s linear infinite; display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .sheet-input {
            background: transparent; border: none; color: #E3E3E3; width: 100%; outline: none; text-align: center;
            font-family: monospace; font-size: 13px; font-weight: 500;
            /* Vertical Align Fix for Inputs */
            display: flex; align-items: center; justify-content: center; height: 100%;
        }
        .sheet-input:focus { background: #2D2E30; }
        
        /* Dashboard Grid Layout */
        .grid-table {
            display: grid;
            gap: 1px; background: #3C4043;
            /* Mobile: Force scroll width */
            grid-template-columns: 35px 140px 140px 120px 80px 30px; 
            min-width: 900px;
        }
        @media (min-width: 768px) {
            .grid-table { 
                grid-template-columns: 40px 1fr 1fr 1fr 100px 30px; 
                min-width: 100%;
            }
        }

        /* Vertical Alignment Applied Here */
        .grid-cell { 
            background: #1E1F20; padding: 0 4px; /* Removed top/bottom padding, used height instead */
            height: 40px; /* Fixed Height for better vertical align */
            display: flex; align-items: center; justify-content: center; /* Flex Center = Vertical + Horizontal Center */
            font-size: 13px; 
        }
        .grid-header { background: #2D2E30; font-weight: bold; color: #8AB4F8; font-size: 0.8rem; }
        .col-hidden { display: none; }

        .fab-btn {
            position: fixed; bottom: 20px; right: 20px; width: 56px; height: 56px; border-radius: 50%;
            background: #8AB4F8; color: #000; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); font-size: 24px; z-index: 50; transition: transform 0.2s;
        }
        .fab-btn:active { transform: scale(0.9); }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <div id="loginPage" class="fixed inset-0 z-50 flex items-center justify-center bg-bg p-4">
        <div class="bg-surface p-8 rounded-xl shadow-2xl w-full max-w-sm border border-border">
            <div class="flex justify-center mb-6"><i class="fa-solid fa-bolt text-5xl text-primary animate-pulse"></i></div>
            <h2 class="text-2xl font-bold text-center mb-1">REB Automation</h2>
            <p class="text-center text-xs text-textDim mb-6">v8.8 Vertical Align</p>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="mb-4"><input type="text" id="userIdInput" class="w-full bg-surface2 border border-border rounded p-3 text-white outline-none focus:border-primary transition" placeholder="User ID" required></div>
                <div class="mb-6"><input type="password" id="passwordInput" class="w-full bg-surface2 border border-border rounded p-3 text-white outline-none focus:border-primary transition" placeholder="Password" required></div>
                <button type="submit" id="loginBtn" class="w-full bg-primary text-black font-bold py-3 rounded hover:bg-blue-400 transition flex justify-center items-center gap-2">Login</button>
            </form>
            <div id="loginMsg" class="text-red-400 text-xs text-center mt-4 h-5"></div>
        </div>
    </div>

    <div id="appLayout" class="hidden flex-col h-full">
        <header class="bg-surface border-b border-border h-14 flex items-center justify-between px-3 shrink-0">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-bolt text-primary text-xl"></i>
                <div>
                    <h1 class="font-bold text-base leading-tight hidden sm:block">REB Auto <span class="text-[10px] text-primary bg-surface2 px-1 rounded">v8.8</span></h1>
                    <div id="displayOffice" class="text-[10px] text-textDim max-w-[150px] truncate">...</div>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <div class="flex bg-surface2 rounded p-0.5">
                    <button onclick="switchTab('dashboard')" id="tab-dashboard" class="px-3 py-1 rounded text-xs bg-bg text-primary font-bold shadow transition">Entry</button>
                    <button onclick="switchTab('history')" id="tab-history" class="px-3 py-1 rounded text-xs text-textDim transition">History</button>
                </div>
                <div class="text-right hidden md:block"><div id="displayUserName" class="text-xs font-bold text-green-400">Guest</div></div>
                <button onclick="logout()" class="text-red-400 bg-surface2 p-2 rounded-full h-8 w-8 flex items-center justify-center hover:bg-red-900/30 ml-2" title="Logout (Keeps Data)"><i class="fa-solid fa-power-off text-xs"></i></button>
            </div>
        </header>

        <main id="view-dashboard" class="flex-1 flex flex-col overflow-hidden relative">
            <div class="h-12 border-b border-border flex items-center px-2 gap-2 shrink-0 bg-surface overflow-x-auto no-scrollbar">
                <button onclick="toggleSettingsModal()" class="bg-surface2 text-textDim hover:text-white px-3 py-1.5 rounded text-xs border border-border whitespace-nowrap"><i class="fa-solid fa-sliders"></i> Config</button>
                <button onclick="addEmptyRow()" class="hidden md:flex bg-surface2 hover:bg-border text-white px-3 py-1.5 rounded text-xs border border-border whitespace-nowrap gap-1 items-center"><i class="fa-solid fa-plus"></i> Add Row</button>
                <button onclick="clearSuccessRows()" class="bg-surface2 hover:bg-red-900/50 text-red-300 px-3 py-1.5 rounded text-xs border border-border whitespace-nowrap"><i class="fa-solid fa-broom"></i> Clear Done</button>
                <div class="flex-1"></div>
                <button id="postBtn" onclick="startPostingOneByOne()" class="bg-green-700 hover:bg-green-600 text-white px-4 py-1.5 rounded text-xs font-bold flex items-center gap-2 shadow-lg whitespace-nowrap"><i class="fa-solid fa-paper-plane"></i> Start Posting</button>
            </div>
            
            <div class="flex-1 overflow-auto bg-bg p-1 sm:p-2">
                <div class="overflow-x-auto pb-20">
                    <div id="meterTable" class="grid-table rounded overflow-hidden">
                        <div class="grid-cell grid-header">#</div>
                        <div class="grid-cell grid-header">Meter No</div>
                        <div class="grid-cell grid-header">Seal No</div>
                        <div class="grid-cell grid-header">Brand</div>
                        <div class="grid-cell grid-header opt-col opt-init col-hidden">Init</div>
                        <div class="grid-cell grid-header opt-col opt-kwh col-hidden">KWH</div>
                        <div class="grid-cell grid-header opt-col opt-demand col-hidden">Dem</div>
                        <div class="grid-cell grid-header opt-col opt-type col-hidden">Type</div>
                        <div class="grid-cell grid-header opt-col opt-bs1 col-hidden">BS1</div>
                        <div class="grid-cell grid-header opt-col opt-bs2 col-hidden">BS2</div>
                        <div class="grid-cell grid-header" style="min-width: 80px;">Status</div>
                        <div class="grid-cell grid-header"><i class="fa-solid fa-trash"></i></div>
                    </div>
                </div>
            </div>
            <button onclick="addEmptyRow()" class="fab-btn md:hidden"><i class="fa-solid fa-plus"></i></button>
        </main>

        <main id="view-history" class="hidden flex-1 flex flex-col overflow-hidden">
            <div class="h-14 border-b border-border flex items-center px-3 gap-2 bg-surface shrink-0">
                <div class="relative flex-1">
                    <i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-textDim text-xs"></i>
                    <input type="text" id="searchInput" onkeyup="renderHistory()" placeholder="Search History..." class="w-full bg-bg border border-border rounded-full py-1.5 pl-8 pr-3 text-sm text-white focus:border-primary outline-none">
                </div>
                <span id="historyCount" class="text-[10px] text-primary bg-surface2 px-2 py-1 rounded whitespace-nowrap">0 Rec</span>
                <button onclick="toggleHistorySettings()" class="text-textDim hover:text-white p-2 rounded"><i class="fa-solid fa-gear"></i></button>
            </div>
            
            <div class="flex-1 overflow-auto bg-bg">
                <table class="w-full text-left border-collapse table-fixed">
                    <thead class="bg-surface2 sticky top-0 text-[11px] uppercase text-textDim z-10 shadow-md">
                        <tr>
                            <th class="p-2 font-semibold border-b border-border w-5/12 align-middle">Meter Info</th>
                            <th class="p-2 font-semibold border-b border-border text-center w-3/12 align-middle">Seal</th>
                            <th class="p-2 font-semibold border-b border-border text-center w-2/12 align-middle">CMO</th>
                            <th class="p-2 font-semibold border-b border-border text-center w-2/12 align-middle">Status</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody" class="divide-y divide-border text-xs"></tbody>
                </table>
            </div>
        </main>
    </div>

    <div id="settingsModal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="bg-surface p-5 rounded-xl w-full max-w-sm border border-border shadow-2xl">
            <h3 class="font-bold mb-4 text-primary">Column Settings</h3>
            <div class="grid grid-cols-2 gap-3 text-sm mb-6">
                <label class="flex items-center gap-2"><input type="checkbox" id="tog-init" onchange="updateColumns(); saveDraft()"> Initial Read</label>
                <label class="flex items-center gap-2"><input type="checkbox" id="tog-kwh" onchange="updateColumns(); saveDraft()"> KWH Read</label>
                <label class="flex items-center gap-2"><input type="checkbox" id="tog-demand" onchange="updateColumns(); saveDraft()"> Demand</label>
                <label class="flex items-center gap-2"><input type="checkbox" id="tog-type" onchange="updateColumns(); saveDraft()"> Meter Type</label>
                <label class="flex items-center gap-2"><input type="checkbox" id="tog-bs1" onchange="updateColumns(); saveDraft()"> Body Seal 1</label>
                <label class="flex items-center gap-2"><input type="checkbox" id="tog-bs2" onchange="updateColumns(); saveDraft()"> Body Seal 2</label>
            </div>
            <button onclick="document.getElementById('settingsModal').classList.add('hidden')" class="w-full bg-surface2 text-white py-2.5 rounded hover:bg-border font-bold">Done</button>
        </div>
    </div>

    <div id="historySettingsModal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="bg-surface p-5 rounded-xl w-full max-w-xs border border-border shadow-2xl">
            <h3 class="font-bold mb-4 text-primary text-center">History Sync</h3>
            <div class="mb-4 flex gap-2">
                <input type="number" id="syncLimitInput" value="300" class="w-20 bg-bg border border-border rounded p-2 text-white text-center outline-none">
                <button id="syncBtn" onclick="manualSyncHistory()" class="flex-1 bg-primary text-black font-bold px-4 py-2 rounded hover:bg-blue-400">Sync Now</button>
            </div>
            <button onclick="clearHistoryCache()" class="w-full bg-red-900/30 text-red-300 border border-red-900 hover:bg-red-900 py-2 rounded text-sm mb-2">Clear Cache</button>
            <button onclick="document.getElementById('historySettingsModal').classList.add('hidden')" class="w-full bg-surface2 text-white py-2 rounded text-sm">Close</button>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000'; 

        const manufacturers = [
            {id:'41', name:'Hexing Inc.'}, {id:'61', name:'Power Plus'}, {id:'64', name:'Echo'},
            {id:'81', name:'Holley'}, {id:'141', name:'B and T'}, {id:'161', name:'TECHNO'},
            {id:'201', name:'D Tech'}, {id:'241', name:'Cell Meter'}, {id:'261', name:'Hexcell'},
            {id:'281', name:'Kaifa'}, {id:'301', name:'HOSAF'}, {id:'321', name:'PASHA'},
            {id:'341', name:'Wasion'}, {id:'361', name:'Jiangsu Linyang'}, {id:'381', name:'HAY'},
            {id:'382', name:'GAUSS'}, {id:'401', name:'ZHEJIANG'}, {id:'402', name:'FUJI'},
            {id:'403', name:'RELIANCE'}, {id:'421', name:'Libra'}, {id:'441', name:'Clou'},
            {id:'461', name:'Super Star'}, {id:'481', name:'Modern'}, {id:'482', name:'Navana'},
            {id:'483', name:'Star'}, {id:'484', name:'Eastern'}, {id:'485', name:'Citizen'},
            {id:'486', name:'Northern'}, {id:'487', name:'Prime'}, {id:'488', name:'Capital'},
            {id:'489', name:'FGF'}, {id:'490', name:'SFS'}, {id:'491', name:'Electro'},
            {id:'501', name:'BPEMC'}, {id:'521', name:'Hangzhou'}, {id:'522', name:'Suzhou'},
            {id:'541', name:'Smart'}, {id:'561', name:'Passol'}, {id:'581', name:'Badhon'},
            {id:'601', name:'JFJ'}
        ];

        const state = {
            user: JSON.parse(localStorage.getItem('reb_user_v8')) || null,
            history: JSON.parse(localStorage.getItem('reb_history_cache')) || [],
            defaults: { manufacturerId: '581', meterType: 'j-39', bodySeal1: 'LS', bodySeal2: 'LS', initialReading: '0', kwhReading: '0', demandReading: '0' }
        };

        // --- CORE ---
        function setBtnLoading(btnId, isLoading, text = '') {
            const btn = document.getElementById(btnId);
            if (!btn) return;
            if (isLoading) {
                btn.disabled = true;
                btn.dataset.originalText = btn.innerHTML;
                btn.innerHTML = `<span class="loader"></span> ${text}`;
                btn.classList.add('opacity-70', 'cursor-not-allowed');
            } else {
                btn.disabled = false;
                btn.innerHTML = btn.dataset.originalText;
                btn.classList.remove('opacity-70', 'cursor-not-allowed');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            if(state.user) initApp();
            else document.getElementById('loginPage').classList.remove('hidden');
            loadSettings();
        });

        async function handleLogin(e) {
            e.preventDefault();
            const uid = document.getElementById('userIdInput').value;
            const pass = document.getElementById('passwordInput').value;
            const msg = document.getElementById('loginMsg');
            
            setBtnLoading('loginBtn', true, 'Checking...');
            msg.innerText = "";

            try {
                const res = await fetch(`${API_BASE}/api/login-check`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userid: uid, password: pass })
                });
                const data = await res.json();

                if(data.status === 'success' && data.pbs && data.pbs !== 'N/A') {
                    let userDisplay = data.user ? (data.user.split(',').length >= 2 ? data.user.split(',').slice(0, 2).join(',') : data.user.split(',')[0]) : uid;
                    state.user = { userid: uid, password: pass, pbs: data.pbs, zonal: data.zonal, displayName: userDisplay };
                    localStorage.setItem('reb_user_v8', JSON.stringify(state.user));
                    initApp();
                } else { msg.innerText = "Login Failed!"; }
            } catch (err) { msg.innerText = "Network Error."; }
            setBtnLoading('loginBtn', false);
        }

        function initApp() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('appLayout').classList.remove('hidden');
            document.getElementById('appLayout').classList.add('flex');
            
            document.getElementById('displayUserName').innerText = state.user.displayName;
            document.getElementById('displayOffice').innerText = state.user.zonal || state.user.pbs; 
            
            restoreDraft();
            if(state.history.length === 0) fetchHistory(300);
            else renderHistory();
        }

        function logout() { localStorage.removeItem('reb_user_v8'); location.reload(); }

        async function startPostingOneByOne() {
            const rows = document.querySelectorAll('.meter-row');
            const queue = [];
            rows.forEach(row => {
                const meter = row.querySelector('.inp-meter').value.trim();
                const seal = row.querySelector('.inp-seal').value.trim();
                const statusCell = row.querySelector('.status-cell');
                if(meter && seal && !statusCell.classList.contains('text-green-500')) {
                    queue.push({ row, data: { meterNo: meter, sealNo: seal, 
                        manufacturerId: row.querySelector('.inp-brand').value,
                        initialReading: row.querySelector('.inp-init').value, 
                        kwhReading: row.querySelector('.inp-kwh').value,
                        demandReading: row.querySelector('.inp-demand').value, 
                        meterType: row.querySelector('.inp-type').value,
                        bodySeal1: row.querySelector('.inp-bs1').value, 
                        bodySeal2: row.querySelector('.inp-bs2').value } 
                    });
                }
            });

            if(queue.length === 0) return alert("Nothing to post!");
            setBtnLoading('postBtn', true, 'Processing...');

            for (let i = 0; i < queue.length; i++) {
                const item = queue[i];
                const st = item.row.querySelector('.status-cell');
                st.innerHTML = '<span class="loader text-primary" style="width:12px;height:12px;"></span>';
                try {
                    await fetch(`${API_BASE}/api/fast-post`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userid: state.user.userid, password: state.user.password, meters: [item.data] }) });
                    
                    st.innerHTML = '<span class="text-yellow-500 text-[10px]">Checking...</span>';
                    await new Promise(r => setTimeout(r, 1500)); 

                    const verifyRes = await fetch(`${API_BASE}/api/all-meter-list`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userid: state.user.userid, password: state.user.password, limit: 5 }) });
                    const verifyData = await verifyRes.json();
                    const found = verifyData.data ? verifyData.data.find(m => m.meterNo === item.data.meterNo) : null;

                    if (found) {
                        st.innerHTML = `<i class="fa-solid fa-check"></i> Done`;
                        st.className = "grid-cell status-cell text-xs font-bold text-green-500";
                        updateHistoryCache(verifyData.data); 
                    } else {
                        st.innerText = "Failed";
                        st.className = "grid-cell status-cell text-xs font-bold text-red-500";
                    }
                } catch (err) { st.innerText = "Error"; st.className = "grid-cell status-cell text-xs font-bold text-red-500"; }
                saveDraft();
            }
            setBtnLoading('postBtn', false);
            renderHistory();
        }

        function updateHistoryCache(newData) {
            const existingMap = new Map(state.history.map(item => [item.meterNo, item]));
            newData.forEach(newItem => existingMap.set(newItem.meterNo, newItem));
            state.history = [...newData, ...state.history.filter(h => !newData.find(n => n.meterNo === h.meterNo))];
            localStorage.setItem('reb_history_cache', JSON.stringify(state.history));
        }

        function renderHistory() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            const list = state.history.filter(i => (i.meterNo && i.meterNo.toLowerCase().includes(q)) || (i.seal && i.seal.toLowerCase().includes(q)));
            document.getElementById('historyCount').innerText = `${list.length} Rec`;
            document.getElementById('historyTableBody').innerHTML = list.map(i => {
                const sealVal = i.seal || i.sealNo || '-';
                let statusColor = 'bg-gray-700 text-gray-300';
                if(i.status === 'Free') statusColor = 'bg-green-900 text-green-300';
                else if(i.status === 'Booked') statusColor = 'bg-red-900 text-red-300';
                else if(i.status === 'Installed') statusColor = 'bg-blue-900 text-blue-300';
                
                return `
                <tr class="hover:bg-surface border-b border-border transition">
                    <td class="p-2 align-middle">
                        <div class="font-bold text-white text-sm">${i.meterNo}</div>
                        <div class="text-[10px] text-textDim flex flex-col leading-tight">
                            <span>${i.brand}</span>
                            <span>${i.date || ''}</span>
                        </div>
                    </td>
                    <td class="p-2 text-center align-middle">
                        <span class="font-mono text-primary text-xs">${sealVal}</span>
                    </td>
                    <td class="p-2 text-center text-textDim font-bold text-xs align-middle">${i.cmo || '-'}</td>
                    <td class="p-2 text-center align-middle">
                        <span class="px-1.5 py-0.5 rounded text-[9px] font-bold uppercase ${statusColor}">${i.status}</span>
                    </td>
                </tr>`;
            }).join('');
        }

        function saveDraft() {
            const rows = [];
            document.querySelectorAll('.meter-row').forEach(row => {
                rows.push({
                    meterNo: row.querySelector('.inp-meter').value, sealNo: row.querySelector('.inp-seal').value,
                    manufacturerId: row.querySelector('.inp-brand').value, initialReading: row.querySelector('.inp-init').value,
                    kwhReading: row.querySelector('.inp-kwh').value, demandReading: row.querySelector('.inp-demand').value,
                    meterType: row.querySelector('.inp-type').value, bodySeal1: row.querySelector('.inp-bs1').value,
                    bodySeal2: row.querySelector('.inp-bs2').value, statusHtml: row.querySelector('.status-cell').innerHTML,
                    isSuccess: row.querySelector('.status-cell').classList.contains('text-green-500')
                });
            });
            localStorage.setItem('reb_draft_rows', JSON.stringify(rows));
            const settings = {}; ['init','kwh','demand','type','bs1','bs2'].forEach(id => settings[id] = document.getElementById(`tog-${id}`).checked);
            localStorage.setItem('reb_settings', JSON.stringify(settings));
        }
        
        function restoreDraft() {
            const savedRows = JSON.parse(localStorage.getItem('reb_draft_rows'));
            const container = document.getElementById('meterTable');
            const headers = Array.from(container.querySelectorAll('.grid-header'));
            container.innerHTML = ''; headers.forEach(h => container.appendChild(h));
            if(savedRows && savedRows.length > 0) { savedRows.forEach((d, i) => { const div = document.createElement('div'); div.className='meter-row'; div.style.display='contents'; div.innerHTML=createRowHtml(i+1, d); container.appendChild(div); }); } else { renderRows(1); }
            updateColumns();
        }

        function createRowHtml(index, data = null) {
            const def = state.defaults;
            const val = {
                meter: data ? data.meterNo : '', seal: data ? data.sealNo : getNextSealSequence(),
                brand: data ? data.manufacturerId : def.manufacturerId, init: data ? data.initialReading : def.initialReading,
                kwh: data ? data.kwhReading : def.kwhReading, demand: data ? data.demandReading : def.demandReading,
                type: data ? data.meterType : def.meterType, bs1: data ? data.bodySeal1 : def.bodySeal1,
                bs2: data ? data.bodySeal2 : def.bodySeal2, status: data ? data.statusHtml : 'Pending',
                statusClass: (data && data.isSuccess) ? "text-green-500" : "text-textDim"
            };
            return `<div class="grid-cell text-textDim text-xs row-index">${index}</div><div class="grid-cell"><input class="sheet-input inp-meter" value="${val.meter}" placeholder="Meter No" oninput="saveDraft()" onkeydown="handleKey(event)"></div><div class="grid-cell"><input class="sheet-input inp-seal" value="${val.seal}" oninput="saveDraft()" onkeydown="handleKey(event)"></div><div class="grid-cell"><select class="sheet-input inp-brand cursor-pointer" onchange="updateGlobalDefault('manufacturerId', this.value)">${getBrandOptions(val.brand)}</select></div><div class="grid-cell opt-col opt-init col-hidden"><input class="sheet-input inp-init" value="${val.init}" oninput="saveDraft()"></div><div class="grid-cell opt-col opt-kwh col-hidden"><input class="sheet-input inp-kwh" value="${val.kwh}" oninput="saveDraft()"></div><div class="grid-cell opt-col opt-demand col-hidden"><input class="sheet-input inp-demand" value="${val.demand}" oninput="saveDraft()"></div><div class="grid-cell opt-col opt-type col-hidden"><input class="sheet-input inp-type" value="${val.type}" onchange="updateGlobalDefault('meterType', this.value)"></div><div class="grid-cell opt-col opt-bs1 col-hidden"><input class="sheet-input inp-bs1" value="${val.bs1}" onchange="updateGlobalDefault('bodySeal1', this.value)"></div><div class="grid-cell opt-col opt-bs2 col-hidden"><input class="sheet-input inp-bs2" value="${val.bs2}" onchange="updateGlobalDefault('bodySeal2', this.value)"></div><div class="grid-cell status-cell text-xs font-bold ${val.statusClass}">${val.status}</div><div class="grid-cell cursor-pointer text-red-400 hover:text-red-200" onclick="deleteRow(this)"><i class="fa-solid fa-trash"></i></div>`;
        }

        function getBrandOptions(selectedId) { return manufacturers.map(m => `<option value="${m.id}" ${m.id == selectedId ? 'selected' : ''}>${m.name}</option>`).join(''); }
        function renderRows(count) { const container = document.getElementById('meterTable'); for(let i=0; i<count; i++) { const div = document.createElement('div'); div.className='meter-row'; div.style.display='contents'; div.innerHTML=createRowHtml(container.querySelectorAll('.meter-row').length+1); container.appendChild(div); } updateColumns(); saveDraft(); }
        function addEmptyRow() { renderRows(1); }
        function deleteRow(btn) { btn.closest('.meter-row').remove(); reIndexRows(); saveDraft(); }
        function reIndexRows() { document.querySelectorAll('.meter-row .row-index').forEach((el, idx) => el.innerText = idx + 1); }
        function clearSuccessRows() { const rows = document.querySelectorAll('.meter-row'); let removed = 0; rows.forEach(row => { if(row.querySelector('.status-cell').classList.contains('text-green-500')) { row.remove(); removed++; } }); if(removed > 0) { reIndexRows(); saveDraft(); } else { alert("No successful entries to clear."); } }
        function handleKey(e) { if(e.key === 'Enter') { e.preventDefault(); const row = e.target.closest('.meter-row'); const next = row.nextElementSibling; if(!next || !next.classList.contains('meter-row')) { addEmptyRow(); setTimeout(() => { if(row.nextElementSibling) row.nextElementSibling.querySelector('.inp-meter').focus(); }, 0); } else { next.querySelector('.inp-meter').focus(); } } }
        function switchTab(tab) { document.getElementById('view-dashboard').classList.add('hidden'); document.getElementById('view-history').classList.add('hidden'); document.getElementById('tab-dashboard').className = "px-3 py-1 rounded text-xs text-textDim transition"; document.getElementById('tab-history').className = "px-3 py-1 rounded text-xs text-textDim transition"; document.getElementById(`view-${tab}`).classList.remove('hidden'); document.getElementById(`tab-${tab}`).className = "px-3 py-1 rounded text-xs bg-bg text-primary font-bold shadow transition"; if(tab === 'dashboard') document.getElementById('view-dashboard').classList.add('flex'); else { document.getElementById('view-history').classList.add('flex'); renderHistory(); } }
        function toggleHistorySettings() { document.getElementById('historySettingsModal').classList.remove('hidden'); }
        function toggleSettingsModal() { document.getElementById('settingsModal').classList.remove('hidden'); }
        async function manualSyncHistory() { setBtnLoading('syncBtn', true, 'Syncing'); await fetchHistory(parseInt(document.getElementById('syncLimitInput').value || 300)); setBtnLoading('syncBtn', false); document.getElementById('historySettingsModal').classList.add('hidden'); }
        function clearHistoryCache() { if(confirm("Clear history?")) { state.history = []; localStorage.removeItem('reb_history_cache'); renderHistory(); document.getElementById('historySettingsModal').classList.add('hidden'); } }
        function getNextSealSequence() { const sealInputs = document.querySelectorAll('.inp-seal'); if(sealInputs.length === 0) return ''; const lastVal = sealInputs[sealInputs.length - 1].value.trim(); if(!lastVal) return ''; const match = lastVal.match(/(\d+)$/); if(match) { const nextNum = (parseInt(match[1], 10) + 1).toString().padStart(match[1].length, '0'); return lastVal.substring(0, match.index) + nextNum; } return lastVal; }
        function updateGlobalDefault(key, value) { state.defaults[key] = value; saveDraft(); }
        async function fetchHistory(limit = 300) { try { const res = await fetch(`${API_BASE}/api/all-meter-list`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userid: state.user.userid, password: state.user.password, limit: limit }) }); const d = await res.json(); if(d.data) { updateHistoryCache(d.data); renderHistory(); } } catch(e) { console.log("Fetch failed", e); } }
        function loadSettings() { const settings = JSON.parse(localStorage.getItem('reb_settings')); if(settings) { for(const key in settings) { const el = document.getElementById(`tog-${key}`); if(el) el.checked = settings[key]; } updateColumns(); } }
        function updateColumns() { 
            const ids = ['init','kwh','demand','type','bs1','bs2']; let cnt = 0; 
            ids.forEach(id => { const chk = document.getElementById(`tog-${id}`).checked; if(chk) cnt++; document.querySelectorAll(`.opt-${id}`).forEach(el => el.classList.toggle('col-hidden', !chk)); }); 
            if(window.innerWidth < 768) document.getElementById('meterTable').style.gridTemplateColumns = `35px 140px 140px 120px ${'100px '.repeat(cnt)} 80px 30px`;
            else document.getElementById('meterTable').style.gridTemplateColumns = `40px 1fr 1fr 1fr ${'1fr '.repeat(cnt)} 100px 30px`;
        }
        window.addEventListener('resize', updateColumns);
    </script>
</body>
</html>